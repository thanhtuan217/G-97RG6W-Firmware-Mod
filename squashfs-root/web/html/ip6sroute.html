<% PrintTemplate1(); %>
<style type="text/css">
</style>
<script type="text/javascript">
//<![CDATA[

var wan_list = new Array();
var route_list = new Array();
var routing_table = [];
var routing_table_v6 = [];

<% WEB_GetRouting(); %>
<% GetRouterWan(); %>
<% ip6sroute_GetConfig(); %>

function showWanList()
{
	var i;
	for (i = 0; i < wan_list.length; i++)
	{
		$("#wanidx").append("<option value=\"" + (parseInt(wan_list[i].index) + 1) + "\">" + wan_list[i].name + "<\/option>");
	}
	$("#wanidx").append("<option value=\"0\">br0<\/option>");
}

function showRouteList()
{
	var i, j, str, ifname;
	for (i = 0; i < route_list.length; i++)
	{
		ifname = "";
		if (route_list[i].wanidx == 0) {
			ifname = "br0";
		} else {
			for (j = 0; j < wan_list.length; j++)
			{
				if ((route_list[i].wanidx - 1) == wan_list[j].index)
				{
					ifname = wan_list[j].name;
					break;
				}
			}
		}
		str = "<tr>";
		str += "<td>" + route_list[i].destip + "<\/td>";
		str += "<td>" + route_list[i].destplen + "<\/td>";
		str += "<td>" + route_list[i].gateway + "<\/td>";
		str += "<td>" + ifname + "<\/td>";
		str += "<td><a class=\"btn remove_btn\" href=\"#\" onclick=\"deleteRoute(" + i + ");\">" + WebString.Remove + "<\/td>";
		str += "<tr>";
		$("#route_list").append(str);
	}
}

function checkSameRule(destip, destplen, gateway)
{
	for (var i = 0; i < route_list.length; i++)
	{
		if (route_list[i].destip == destip && route_list[i].destplen == destplen 
			&& route_list[i].gateway == gateway)
			return false;
	}
	
	return true;
}

function checkValue()
{
	var flag = true;
	var obj = new Object();
	if (route_list.length >= 32)
	{
		alert(WebString.rulefull);
		return false;
	}	
	if ($("#destip").val() == '') {
		alert(WebString.ipv6_addr_alert);
		return false;
	}
	if (isValidIpAddress6($("#destip").val()) == false)
	{
		alert(WebString.ipv6_addr_alert);
		return false;
	}
	if (isValidRoutePrefixLength(parseInt($("#destplen").val())) == false)
	{
		alert(WebString.ipv6route_plen_alert);
		return false;
	}
	if (isValidIpAddress6($("#gateway").val()) == false)
	{
		alert(WebString.ipv6_addr_alert);
		return false;
	}
	if ($("#gateway").val() == $("#destip").val())
	{
		alert(WebString.ipv6_addr_alert);
		return false;
	}
	if (checkSameRule($("#destip").val(), $("#destplen").val(), $("#gateway").val()) == false)
	{
		alert(WebString.samerule);
		return false;
	}
	$.each(routing_table_v6,function(id,el){
		var tmp = el.destip.split('/');
		if($("#destip").val() == tmp[0] && $("#destplen").val() == tmp[1] && $("#gateway").val() == el.gateway)
		{
			if($("#wanidx").val() == 0 && el.interface == "br0")
			{
				flag = false;
				return false;
			}
			else if($("#wanidx").val() != 0 && (el.interface.charAt(el.interface.length - 1) + 1) == $("#wanidx").val())
			{
				flag = false;
				return false;
			}
		}
	});
	if(flag == false)
	{
		alert(WebString.existed_rule);
		return false;
	}

	return true;
}

function deleteRoute(idx)
{
	if (!confirm(WebString.delete_confirm))
	{
		return;
	}
	$("#destip").val(route_list[idx].destip);
	$("#destplen").val(route_list[idx].destplen);
	$("#gateway").val(route_list[idx].gateway);
	$("#route_act").val("1");
	$("#XForm").submit();
}

function WebInit()
{
	showWanList();
	showRouteList();
	WebStepIndex();
}

function WebDoSubmit()
{
	if (false == checkValue())
	{
		return;
	}
	$("#route_act").val("0");
	$("#XForm").submit();
}

$(document).ready(function () {
	$("#btn_apply").click(function() {
        XDoSubmit();
    });
});

//]]>
</script>
<% PrintTemplate2(); %>

<div class="cfgstep">
	<p><strong id="XS0"></strong></p>
	<table>
		<tr>
			<td id="XS1" width="200"></td>
			<td><input type="text" name="destip" id="destip" maxlength="39" size="40" style="ime-mode:disabled" /></td>
		</tr>
		<tr>
			<td id="XS2" width="200"></td>
			<td><input type="text" name="destplen" id="destplen" maxlength="3" size="6" style="ime-mode:disabled" onkeypress="return OnKeyPress(event, X_INPUT_NUM);" /></td>
		</tr>
		<tr>
			<td id="XS3" width="200"></td>
			<td><input type="text" name="gateway" id="gateway" maxlength="39" size="40" style="ime-mode:disabled" /></td>
		</tr>
		<tr>
			<td id="XS4" width="200"></td>
			<td><select name="wanidx" id="wanidx">
				</select></td>
		</tr>
	</table>
</div>

<div class="cfgstep">
	<p><strong><script type="text/javascript">document.write(XsrouteString[10]);</script></strong></p>
	<a id="btn_apply" class="btn apply_btn" href="#"><script type="text/javascript">document.write(WebString.Add);</script></a>
	<input id="route_act" name="route_act" type="hidden" />
</div>

<div class="cfglist">
	<table id="route_list">
		<tr>
			<th id="XS5" colspan="5" class="tableTitle"></th>
		</tr>
		<tr>
			<th id="XS6" style="width: 20%"></th>
			<th id="XS7" style="width: 20%"></th>
			<th id="XS8" style="width: 20%"></th>
			<th id="XS9" style="width: 25%"></th>
			<th style="width: 15%"><script type="text/javascript">document.write(WebString.Edit);</script></th>		
		</tr>
	</table>  
</div>

<% PrintTemplate3(); %>