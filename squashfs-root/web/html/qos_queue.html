<% PrintTemplate1(); %>
<style type="text/css">
</style>
<script type="text/javascript">
//<![CDATA[
//init data started
var enable=0;
var usrate=0;
var count=0;
var rules_max=0;
var rules = new Array();

var queue_num = 0;
var queue = new Array();
var uniMode = new Array();

//data from web server started
<% QOS_XGetConfig(); %>
//data from web server ended

//init data ended

//Client contents started
var weight_max = 63;
var weight_min = 1;
var rate_max = 1000000;
var rate_min = 0;

function showQueueCfg(queueArr, queueNum)
{
	//queue config
	var i = 0;
	var str = "";
	var queue_index=0;
	for (i=0; i<queueNum; i++)
	{
		str = "";
		queue_index = i+1;
		str += (
			'<tr align="center">'+
			'	<td>'+ XqosString[7] + ' ' + queue_index+'</td>'+
			'	<td> <input id="queue'+queue_index+'_enable" type="checkbox" name="queue'+ queue_index +'_enable" onchange="doQueueEnable('+ queue_index +')">'+ XqosString[81] +'</td>'+
			'	<td>'+
			'		<select id="queue'+queue_index+'_mode" name="queue'+queue_index+'_mode" onchange="doQueueMode('+ queue_index +'); doQueueModeCheckVal();" >'+
			'			<option value="0" id="queue'+queue_index+'_mode_v0">SP</option>'+
			'			<option value="1" id="queue'+queue_index+'_mode_v1">WRR</option>'+
			'		</select>'+
			'	</td>'+
			'	<td>'+
			'	<select id="queue'+queue_index+'_priority" name="queue'+queue_index+'_priority">'+
			'			<option value="0">0('+ XqosString[80] +')</option>'+
			'			<option value="1">1</option>'+
			'			<option value="2">2</option>'+
			'			<option value="3">3</option>'+
			'			<option value="4">4</option>'+
			'			<option value="5">5</option>'+
			'			<option value="6">6</option>'+
			'			<option value="7">7</option>'+
			'	</select>'+
			'	</td>'+
			'	<td> <input id="queue'+queue_index+'_weight" name="queue'+queue_index+'_weight" type="text" size="2" maxlength="2" ><br />(1-63)</td>'+
			'	<td class="class_rate_content_cfg"> <input id="queue'+queue_index+'_rate" name="queue'+queue_index+'_rate" type="text" size="10" maxlength="10"></td>'+
			'</tr>'
		);
		
		$("#table_queue_cfg").append(str);
		
		//display mode
		$("#queue"+queue_index+"_mode").attr("value", queueArr[i].queue_mode);

		//display priority
		$("#queue"+queue_index+"_priority").attr("value", queueArr[i].queue_priority);
		
		//display weight
		$("#queue"+queue_index+"_weight").attr("value", queueArr[i].queue_weight);
		//display rate
		$("#queue"+queue_index+"_rate").attr("value", queueArr[i].queue_rate);
		//display enable
		if(queueArr[i].queue_enable)
		{
			$("#queue"+queue_index+"_enable").attr("checked", true);
		}

		//do action
		doQueueMode(queue_index);
		doQueueModeCheckVal();
		doQueueEnable(queue_index);
	}
}

function doQueueWeightEnable(queue_index, en)
{
	var weight = $("#queue"+queue_index+"_weight").attr("value");
	
	if(weight == 0) //0 is invalid
		weight = 1; //set to default.
	
	if(en == 0) //disable
	{
		$("#queue"+queue_index+"_weight").attr("disabled", "disabled");
		$("#queue"+queue_index+"_weight").attr("value", weight);
	}
	else
	{
		$("#queue"+queue_index+"_weight").removeAttr("disabled");
		$("#queue"+queue_index+"_weight").attr("value", weight);
	}
}

function doQueueEnable(queue_index)
{
	if($("#queue"+queue_index+"_enable").attr("checked") == "checked")
	{
		$("#queue"+queue_index+"_mode").removeAttr("disabled");
		doQueueMode(queue_index);
		$("#queue"+queue_index+"_rate").removeAttr("disabled");
	}
	else
	{
		$("#queue"+queue_index+"_mode").attr("disabled", "disabled");
		$("#queue"+queue_index+"_priority").attr("disabled", "disabled");
		//$("#queue"+queue_index+"_weight").attr("disabled", "disabled");
		doQueueWeightEnable(queue_index, 0);
		$("#queue"+queue_index+"_rate").attr("disabled", "disabled");
	}
}

function doQueueMode(queue_index)
{
	if($("#queue"+queue_index+"_enable").attr("checked") == "checked")
	{
		if ($("#queue"+queue_index+"_mode").attr("value") == "0") //sp
		{
			if($("#queue"+queue_index+"_priority").attr("disabled") == "disabled")
			{
				$("#queue"+queue_index+"_priority").removeAttr("disabled");
			}
			doQueueWeightEnable(queue_index, 0);
		}
		else //wrr
		{
			$("#queue"+queue_index+"_priority").attr("disabled", "disabled");
			if($("#queue"+queue_index+"_weight").attr("disabled") == "disabled")
			{
				doQueueWeightEnable(queue_index, 1);
			}
		}
	}
}

//check if wrr queue exceeded
function doQueueModeCheckVal()
{
	var i = 1, j=0, h=1;
	
	for(i=1; i<=queue_num; i++)
	{
		if($("#queue"+i+"_enable").attr("checked") == "checked"
		&& $("#queue"+i+"_mode").attr("value") == "1")
		{
			j++;
		}
		else
		{
			h=i;
		}
	}

	//reach wrr queue limitation 7
	if(j==7)
	{
		$("#queue"+h+"_mode_v1").hide(); //hide the rest queue's wrr option
	}
	else if(j<7)
	{
		for(i=1; i<=queue_num; i++)
		{
			$("#queue"+i+"_mode_v1").show();
		}
	}
	else if(j > 7) //error, need corrected.
	{
		$("#queue"+h+"_mode").attr("value", "0");
		doQueueMode(h);
		$("#queue"+h+"_mode_v1").hide();
	}
}

function isDecDigitString(str)
{
	var strArr = str.split("");
	var i = 0;
	var ret = true;
	
	for(i=0; i<strArr.length; i++)
	{
		if(!isDecDigit(strArr[i]))
		{
			ret = false;
			break;
		}
	}
	
	return ret;
}

function doCheckQueuCfg(queueNum)
{
	var ret = 0;
	var val = 0;
	var i = 0;
	var str = "";
	for(i=0; i<queueNum; i++)
	{
		if($("#queue"+(i+1)+"_enable").attr("checked") == "checked")
		{
			//weight
			if($("#queue"+(i+1)+"_mode").attr("value") == "1")
			{
				val = $("#queue"+(i+1)+"_weight").attr("value");
				if(!isDecDigitString(val))
				{
					ret |= 0x1;
				}
				else if(!(val >= weight_min &&  val <= weight_max))
				{
					ret |= 0x10;
				}
			}
			//rate
			val = $("#queue"+(i+1)+"_rate").attr("value");
			if(!isDecDigitString(val))
			{
				ret |= 0x2;
			}
			else if(!(val >= rate_min &&  val <= rate_max))
			{
				ret |= 0x20;
			}
		}
	}
	if(ret != 0)
	{
		if(ret & 0x1)
			str += (WebString.qos_queue_weight_alert_FE) + "\r\n";
		if(ret & 0x10)
			str += (WebString.qos_queue_weight_alert_OOR) + " ("+ weight_min +"-"+ weight_max +")\r\n";
		if(ret & 0x2)
			str += (WebString.qos_queue_rate_alert_FE) + "\r\n";
		if(ret & 0x20)
			str += (WebString.qos_queue_rate_alert_OOR) + " ("+ rate_min +"-"+ rate_max +")\r\n";
		alert(str);
	}

	return ret;
}

function doSubmit(op)
{
	//check input
	if(op == 3)
	{
		if(doCheckQueuCfg(queue_num) != 0)
		{
			return 1;
		}
	}

	$("#qos_op").attr("value", op);
	XDoSubmit();
}

function WebDoSubmit()
{
	$("#XForm").submit();
}

//---------------init value--------------------
function WebInit()
{
	showQueueCfg(queue, queue_num);

	//don't show rate in queue cfg:
	$(".class_rate_content_cfg").hide();
	$(".class_rate_title_cfg").hide();
	
	WebStepIndex();
}

//-------------setup triger--------------------
$(document).ready(function(){
	$("input").css("ime-mode","disabled");

	//op 3 , queue config
	$("#queue_cfg_apply").click(function(){
		doSubmit(3);
	});
	
});

//client contents ended

//]]>
</script>
<% PrintTemplate2(); %>

			<!-- contents started -->
			<div id="qos_queue">
				<div class="cfgstep">
					<p><strong id="XS71"></strong> </p>
					<table>
					<tbody id="table_queue_cfg">
						<tr>
							<th width="60" id="XS72"></th>
							<th width="94" id="XS73"></th>
							<th width="157" id="XS74"></th>
							<th width="94" id="XS75"></th>
							<th width="63" id="XS76"></th>
							<th width="104" id="XS77" class="class_rate_title_cfg"></th>
						</tr>
					</tbody>
				  </table>
				</div>

				<div style="display: block;" class="cfgstep" id="apply_hide">
					<p><strong id="XS78"></strong></p>
						   <a href="#" class="btn apply_btn"  id="queue_cfg_apply" id="XS79"><script type="text/javascript">
						document.write(XqosString[79]);</script></a>
				</div>
			</div>
			<div style="display:none">
				<input name="qos_op" id="qos_op" value="" type="text" size="80">
			</div>
		</div>
		<!-- contents ended -->

<% PrintTemplate3(); %>