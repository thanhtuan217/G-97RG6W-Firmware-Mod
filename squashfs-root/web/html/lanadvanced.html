<% PrintTemplate1(); %>
<style type="text/css">
</style>
<script type="text/javascript">
//<![CDATA[

var lan_ip = "";
var lan_mask = "";
var dhcp_enable = 1;
var start_ip = "";
var end_ip = "";
var dhcp_lease_time = 0;
var pool_enable = 0;
var dns_mode = 0;
var manual_dns1 = "";
var manual_dns2 = "";

var option60Data = new Array();
var option60_list = new Array();
var vendorlist = new Array();   //pool[0] vendor data from cgi
var pool = new Array();
var local_ip = "";

<% LANAdvanced_GetConfig(); %>

function dataInit()
{
    $("#lan_ip").val(lan_ip);
    $("#lan_mask").val(lan_mask);
    $("#start_ip").val(start_ip);
    $("#end_ip").val(end_ip);
    $("#dns_primary").val(manual_dns1);
    $("#dns_secondary").val(manual_dns2);
    $("#time_day").val( parseInt(dhcp_lease_time/(24*60)) );
    $("#time_hour").val( parseInt(dhcp_lease_time%(24*60)/(60)) );
    $("#time_minu").val( parseInt(dhcp_lease_time%60) );
    if (1 == dhcp_enable)
        $("#dhcp_enable0").attr("checked", true);
    else
        $("#dhcp_enable1").attr("checked", true);
      
    if (1 == dns_mode)
        $("#dns_ovwrt0").attr("checked", true);
    else
        $("#dns_ovwrt1").attr("checked", true);   
}

function dhcpserver_enable()
{
    var val = $('input:radio[name="dhcp_enable"]:checked').val();
    
    if(1 == val)
    {
        $("#default_addr_range_div").show();
        $("#option60_div").show();
        $("#dhcp_leasetime_div").show();
        $("#dns_overwrite_div").show();
    }
    else
    {
        $("#default_addr_range_div").hide();
        $("#option60_div").hide();
        $("#dhcp_leasetime_div").hide();
        $("#dns_overwrite_div").hide();
        $("#start_ip").val("");
        $("#end_ip").val(""); 
        $("#option60cfgvalue").val("");       
        $("#leasetime").val("0");
        $("#dns_ovwrt1").attr("checked", true);
    }
    WebStepIndex();
}

function dns_overwrite_manual()
{
    var val=$('input:radio[name="dns_overwrite"]:checked').val();
    if(1 == val)
    {
        $("#primary_dns").show();
        $("#secondary_dns").show();
        if( "" == manual_dns1)
            $("#primary_dns").val($("#lan_ip").val());
        else
            $("#primary_dns").val(manual_dns1);
    }
    else
    { 
        $("#primary_dns").hide();
        $("#secondary_dns").hide();
        $("#dns_primary").val("");
        $("#dns_secondary").val("");
    }
}


function Option60TableFresh()
{
    var TR = "";
    TR += '<table id="Option60Table" class="commonlist">\n';
    TR += '<tr>\n';
    TR += '<th style="width: 60%;">' + XlanadvancedString[8] + '</th>\n';
    TR += '<th style="width: 40%;">' + WebString.Edit + '</th>\n';
    TR += '</tr>\n';
    var post_str="";

    for (var i = 0; i < option60Data.length; i++)
    {
        var option60 = option60Data[i].option60;         
        post_str += option60 + "~";

        TR += '<tr>\n';
        TR += '<td style="word-break : break-all;">' + option60 + '</td>\n';
        TR += '<td><a href="#" class="btn remove_btn" onclick="DeleteOption(this);" >' + WebString.Remove + '</a></td>';
        TR += '</tr>\n';        
    }    
    
    TR += '</table>\n';
    $("#Option60PoolTableContainer").html(TR);
    $("#option60cfgvalue").val(post_str);

    WebStyleCommonList();
}

function DeleteOption(r)
{
    WebResetTimer();

    var row = r.parentNode.parentNode.rowIndex;
    var len = option60Data.length;
    for (var i = row-1; i < option60Data.length; i++ )
    {
        option60Data[i] = option60Data[i+1];
    }
    option60Data.pop();
    Option60TableFresh();
}

function Option60DataBind()
{
    WebResetTimer();

    var option60 = $("#dhcp_option60").val();
    var obj = new Object();

    if(option60Data.length >= 4)
    {
        alert(WebString.dhcp_opt60_max_num);
        return false;
    }

    if("" == option60)
    {
        alert(WebString.valid_option60);
        return false;
    }

    for (var i = 0; i < option60Data.length; i++ )
    {
        if(option60 == option60Data[i].option60)
        {
            alert(WebString.same_option60);
            return false;
        }
    }
    
    obj.option60 = option60;
    option60Data.push(obj);
    Option60TableFresh();
}

function BindOption60Value()
{
    this.option60;
}

function InitTable()
{
    var i;
    for(i = 0; i < option60_list.length; i++)    
    {              
        option60Data[i]=new BindOption60Value();
        option60Data[i].option60 = option60_list[i].option60;
    }
}

function is2LanSubnetDiffer()
{
    var lanip = $("#lan_ip").val();
    var lanmask = $("#lan_mask").val();
    var subnet1 = Ip2Num(pool[0].lan_ip)&Ip2Num(pool[0].lan_mask);
    var subnet2 = Ip2Num(lanip)&Ip2Num(lanmask);
    var pptpd_lanip = local_ip;
    var pptpd_subnet = Ip2Num(pptpd_lanip) & Ip2Num(lanmask);

    if (false == isValidIpAddress(lanip))
    {
        alert(WebString.ip_alert);
        return false;
    }

    if (false == isValidSubnetMask(lanmask))
    {
        alert(WebString.netmask_alert);
        return false;
    }

    if (false == isValidUnicastIpAddress(lanip, lanmask))
    {
        alert(WebString.unicastip);
        return false;
    }

    if( subnet1 == subnet2)
    {
        alert(WebString.same_subnet);
        return false;
    }
    
    if( subnet2 == pptpd_subnet)
    {
        alert(WebString.pptpd_same_subnet_alert);
        return false;
    }
    return true;
}

function LocalSubnetChange()
{
    if (false == is2LanSubnetDiffer())
    {
        return false;
    }

    if(1 == $('input:radio[name="dhcp_enable"]:checked').val())
    {  
        var n_lan_ip = Ip2Num($("#lan_ip").val()) >>> 0;
        var n_lan_mask = Ip2Num($("#lan_mask").val()) >>> 0;
        var n_ip_start = Ip2Num($("#start_ip").val()) >>> 0;
        var n_ip_end = Ip2Num($("#end_ip").val()) >>> 0;
        var n_subnet = (n_lan_ip & n_lan_mask);

        if( !isValidIpAddress($("#start_ip").val()) || !isValidIpAddress($("#end_ip").val()) )
        {
            alert(WebString.ip_alert);
            return false;
        }

        if( lan_ip != $("#lan_ip").val() && n_subnet != ((Ip2Num(lan_ip) >>> 0) & (Ip2Num(lan_mask) >>> 0)) )
        {
            alert(WebString.subnet_changed);
            var new_ipstart = n_ip_start - (n_ip_start & n_lan_mask) + n_subnet;
            var new_ipend = n_ip_end - (n_ip_end & n_lan_mask) + n_subnet;
            $("#start_ip").val(Num2Ip(new_ipstart));
            $("#end_ip").val(Num2Ip(new_ipend));
        }
    } 
    return true;
}

function WebInit()
{
    dataInit();      
    dhcpserver_enable();
    dns_overwrite_manual();
    InitTable();
    Option60TableFresh();
    WebStepIndex();   
}

$(document).ready(function (){
	$("input").css("ime-mode","disabled");
    $("#btn_apply").click(function(){
        XDoSubmit();
    });
    
    $("#addoption60").click(function(){
        Option60DataBind();
    });     

    $("input[name='dhcp_enable']").click(function() {
        dhcpserver_enable();
    });

    $("input[name='dns_overwrite']").click(function() {
        dns_overwrite_manual();
    });
    
    $("input[name='lan_ip']").change(function() {
        LocalSubnetChange();
    });
    
    $("input[name='lan_mask']").change(function() {
        LocalSubnetChange();
    });
    
});

function CheckSetValue()
{
    if (false == is2LanSubnetDiffer())
    {
        return false;
    }
    
    if(1 == $('input:radio[name="dhcp_enable"]:checked').val())
    {
        var n_lan_ip = Ip2Num($("#lan_ip").val()) >>> 0;
        var n_lan_mask = Ip2Num($("#lan_mask").val()) >>> 0;
        var n_ip_start = Ip2Num($("#start_ip").val()) >>> 0;
        var n_ip_end = Ip2Num($("#end_ip").val()) >>> 0;
        var n_subnet = (n_lan_ip & n_lan_mask);

        if( !isValidIpAddress($("#start_ip").val()) || !isValidIpAddress($("#end_ip").val()) )
        {
            alert(WebString.ip_alert);
            return false;
        }
        
        if (false == isValidUnicastIpAddress($("#start_ip").val(), $("#lan_mask").val())
        || false == isValidUnicastIpAddress($("#end_ip").val(), $("#lan_mask").val()))
        {
            alert(WebString.unicastip);
            return false;
        } 
        
        if(n_lan_ip == n_ip_start || n_lan_ip == n_ip_end)
        {
            alert(WebString.ip_conflict);
            return false;	
        }

        if (n_subnet != (n_ip_start & n_lan_mask))
        {
            alert(WebString.diff_subnet);
            return false;
        }
        if (n_subnet != (n_ip_end & n_lan_mask))
        {
            alert(WebString.diff_subnet);
            return false;
        }
       
        if(n_ip_start > n_ip_end)
        {
            alert(WebString.addr_beyond);
            return false;
        }
        
        if(1 == $('input:radio[name="dns_overwrite"]:checked').val())
        {
            var dns1 = $("#dns_primary").val();
            var dns2 = $("#dns_secondary").val();
            if(dns1.length > 0 && dns1 != "0.0.0.0")
            {
                if (false == isValidDnsIpAddress(dns1))
                {
                    alert(WebString.wan_pridns_alert);
                    return false;
                }
            }
            if(dns2.length > 0 && dns2 != "0.0.0.0")
            {
                if (false == isValidDnsIpAddress(dns2))
                {
                    alert(WebString.wan_secdns_alert);
                    return false;
                }
                if (dns1 == dns2)
                {
                    alert(WebString.wan_prisec_alert);
                    return false;
                }
            }
            if(("" == dns1 && "" == dns2) || ("0.0.0.0" == dns1 && "0.0.0.0" == dns2))
            {
                alert(WebString.dns_valid);
                return false;         
            }
            if(("" == dns1 || "0.0.0.0" == dns1) && ("" == dns2 || "0.0.0.0" == dns2))
            {
                $("#dns_primary").val($("#lan_ip").val());
                $("#dns_secondary").val("0.0.0.0");
            }           
        }
                
        var time_day = parseInt($("#time_day").attr("value"));
        var time_hour = parseInt($("#time_hour").attr("value"));
        var time_minu = parseInt($("#time_minu").attr("value"));
        if(time_day < 0 || time_day > 365)
        {
            alert(WebString.day_alert);
            return false;            
        }
        if(time_hour < 0 || time_hour > 23)
        {
            alert(WebString.hour_alert);
            return false;            
        }
        if(time_minu < 0 || time_minu > 59)
        {
            alert(WebString.minute_alert);
            return false;            
        }
        
        var dhcpleasetime = time_day * 24 * 60 + time_hour * 60 + time_minu;
        if(2 > dhcpleasetime)
        {
            alert(WebString.min_leasetime);
            return false; 
        }
        $("#leasetime").val(dhcpleasetime);
    }
               
    return true;
}

function WebDoSubmit()
{   
    if( false == CheckSetValue())
    {
        return;
    }
    $("#XForm").submit();
}


//]]>
</script>
<% PrintTemplate2(); %>

<div class="cfgstep">
    <p><strong id="XS0"></strong></p>
    <table>
        <tr>
            <td width="200" id="XS1"></td>
            <td><input type="text" name="lan_ip" id="lan_ip" maxlength="15" onkeypress="return OnKeyPress(event, X_INPUT_IP);"/></td>
        </tr>
        <tr>
            <td width="200" id="XS2"></td>
            <td><input type="text" name="lan_mask" id="lan_mask" maxlength="15" onkeypress="return OnKeyPress(event, X_INPUT_IP);"/></td>
        </tr>
        <tr>
            <td width="200" id="XS3"></td>
            <td><input type="radio" name="dhcp_enable" id="dhcp_enable0" value="1" checked /><script>document.write(WebString.Enable);</script>
                <input type="radio" name="dhcp_enable" id="dhcp_enable1" value="0" /><script>document.write(WebString.Disable);</script></td>
        </tr>
    </table>
</div>

<div id="default_addr_range_div" class="cfgstep">
    <p><strong id="XS4"></strong></p>
    <table>
        <tr>
            <td width="200" id="XS5"></td>
            <td><input type="text" name="start_ip" id="start_ip" maxlength="15" onkeypress="return OnKeyPress(event, X_INPUT_IP);"/></td>
        </tr>
        <tr>
            <td width="200" id="XS6"></td>
            <td><input type="text" name="end_ip" id="end_ip" maxlength="15" onkeypress="return OnKeyPress(event, X_INPUT_IP);"/></td>
        </tr>
    </table>
</div>

<div id="option60_div" class="cfgstep" style="display:none">
    <p><strong id="XS7"></strong></p>
    <table >
        <tr id="start_60">
            <td width="200" id="XS8"></td>
            <td><input type="text"  id="dhcp_option60" name="dhcp_option60" maxlength="63" />
                <a id="addoption60" name="addoption60" class="btn" href="#"/><script>document.write(WebString.Add);</script></a>
            </td>
        </tr>
        <tr id="options_add">
            <td colspan="2">                
                <input id="option60cfgvalue" name="option60cfgvalue" type="hidden" value=""  />
            </td>
        </tr>
    </table>
    <div id="Option60PoolTableContainer"></div>
</div>

<div id="dhcp_leasetime_div" class="cfgstep">
    <p><strong id="XS9"></strong></p>
    <table>
        <tr>
            <td width="200" id="XS10"></td>
            <td>
                <input type="text" id="time_day" name="time_day" value="1" maxlength="3" size="3" onkeypress="return OnKeyPress(event, X_INPUT_NUM);"/><script>document.write(WebString.days);</script>
                <input type="text" id="time_hour" name="time_hour" value="12" maxlength="3" size="3" onkeypress="return OnKeyPress(event, X_INPUT_NUM);"/><script>document.write(WebString.hours);</script>
                <input type="text" id="time_minu" name="time_minu" value="30" maxlength="3" size="3" onkeypress="return OnKeyPress(event, X_INPUT_NUM);"/><script>document.write(WebString.minutes);</script>
                <input id="leasetime" name="leasetime" type="hidden" value=""  /></td>
        </tr>
    </table>
</div>

<div id="dns_overwrite_div" class="cfgstep">
    <p><strong id="XS11"></strong></p>
    <table>
        <tr>
            <td width="200" id="XS12"></td>
            <td><input type="radio" name="dns_overwrite" id="dns_ovwrt0" value="1" /><script>document.write(WebString.Enable);</script>
                <input type="radio" name="dns_overwrite" id="dns_ovwrt1" value="0" checked /><script>document.write(WebString.Disable);</script></td>
        </tr>
        <tr id="primary_dns" style="display:none">
            <td width="200" id="XS13"></td>
            <td><input type="text" name="dns_primary" id="dns_primary" maxlength="15" onkeypress="return OnKeyPress(event, X_INPUT_IP);"/></td>
        </tr>
        <tr id="secondary_dns" style="display:none">
            <td id="XS14"></td>
            <td><input type="text" name="dns_secondary" id="dns_secondary" maxlength="15" onkeypress="return OnKeyPress(event, X_INPUT_IP);"/></td>
        </tr>
    </table>
</div>

<div class="cfgstep">
    <p><strong><script>document.write(WebString.stepApply);</script></strong></p>
    <a id="btn_apply" class="btn" href="#"><script>document.write(WebString.Apply);</script></a>
</div>

<% PrintTemplate3(); %>
